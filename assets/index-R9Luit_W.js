(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();class O{constructor(){this.currentUser=null,this.currentPage=null,this.currentNote=null,this.userData={pages:[],notes:[]},this.isCodeVisible=!1,this.chatSessions=[],this.currentChatId=null,this.eventsInitialized=!1,this.supabaseUrl="https://bchaobnjfrmzvlmqeoge.supabase.co",this.supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjaGFvYm5qZnJtenZsbXFlb2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMjk0NjMsImV4cCI6MjA2NTcwNTQ2M30.CeH2qS0brRJVCgiskfgTTJwlEqlBMHmc39ZZ8zghtGY";try{this.supabase=supabase.createClient(this.supabaseUrl,this.supabaseKey)}catch{console.warn("Supabase não configurado, usando localStorage apenas"),this.supabase=null}this.customCursor=null,this.currentTheme=localStorage.getItem("rhodium_theme")||"classic",this.toastQueue=[],this.soundEnabled=localStorage.getItem("rhodium_sound")!=="false",this.soundEventsAdded=!1,this.init()}init(){this.ensureDefaultTheme(),this.setupCustomCursor(),this.setupThemeToggle(),this.setupSoundSystem(),this.setupToastSystem(),this.bindEvents(),this.checkAuthState(),this.setupTabs(),this.setupTextTools(),this.setupAI(),this.setupDragAndDrop(),this.setupScrollSpy(),this.setupLibrarySystem(),this.setupUploadSystem(),this.setupSearchSystem(),this.setupPDFViewer(),this.initializeFunctionalFeatures()}initializeFunctionalFeatures(){this.setupWordCounter(),this.setupGlobalSearch(),this.setupAutoBackup(),this.setupFavoriteSystem()}setupButtonListeners(){document.querySelector('.library-control-btn[data-action="filterFavorites"]').addEventListener("click",()=>this.filterFavorites()),document.querySelector('.library-control-btn[data-action="showAddBookModal"]').addEventListener("click",()=>this.showAddBookModal()),document.querySelector('.library-control-btn[data-action="showAllBooks"]').addEventListener("click",()=>this.showAllBooks())}filterFavorites(){const e=this.library.filter(t=>t.favorite);this.renderLibrary(e)}showAddBookModal(){new bootstrap.Modal(document.getElementById("addBookModal")).show()}showAllBooks(){this.renderLibrary(this.library)}renderLibrary(e){const t=document.getElementById("libraryContainer");t.innerHTML="",e.forEach(s=>{const a=this.createBookElement(s);t.appendChild(a)})}createBookElement(e){const t=document.createElement("div");return t.className="library-item",t.innerHTML=`<h4>${e.title}</h4>
                         <p>${e.author}</p>
                         <a href="${e.pdfUrl}" target="_blank">Read PDF</a>
                         <button onclick="app.toggleFavorite('${e.id}')">Favorite</button>`,t}toggleFavorite(e){const t=this.library.find(s=>s.id===e);t&&(t.favorite=!t.favorite,this.renderLibrary(this.library))}setupWordCounter(){const e=document.getElementById("wordCountText");if(e){const t=()=>{const s=e.value,a=s.length,o=s.trim()?s.trim().split(/\s+/).length:0,n=s.trim()?s.split(/[.!?]+/).filter(f=>f.trim().length>0).length:0,c=s.trim()?s.split(/\n\s*\n/).filter(f=>f.trim().length>0).length:0;document.getElementById("charCount").textContent=a,document.getElementById("wordCount").textContent=o,document.getElementById("sentenceCount").textContent=n,document.getElementById("paragraphCount").textContent=c;const r=n>0?Math.round(o/n*10)/10:0,l=o>0?Math.round(a/o*10)/10:0,h=Math.ceil(o/200);document.getElementById("avgWords").textContent=r,document.getElementById("avgChars").textContent=l,document.getElementById("readingTime").textContent=h+" min"};e.addEventListener("input",t),e.addEventListener("paste",()=>setTimeout(t,100))}}setupGlobalSearch(){document.addEventListener("keydown",e=>{e.ctrlKey&&e.key==="k"&&(e.preventDefault(),this.showGlobalSearchModal())})}showGlobalSearchModal(){const e=document.createElement("div");e.className="search-modal-overlay",e.innerHTML=`
            <div class="search-modal glass">
                <div class="search-header">
                    <input type="text" id="globalSearchInput" placeholder="Pesquisar em páginas, notas e biblioteca..." autofocus>
                    <button class="search-close">&times;</button>
                </div>
                <div class="search-results" id="globalSearchResults">
                    <div class="search-placeholder">Digite para começar a pesquisar...</div>
                </div>
            </div>
        `,document.body.appendChild(e);const t=e.querySelector("#globalSearchInput"),s=e.querySelector("#globalSearchResults"),a=e.querySelector(".search-close"),o=n=>{if(!n.trim()){s.innerHTML='<div class="search-placeholder">Digite para começar a pesquisar...</div>';return}const c=[];this.userData.pages.forEach(r=>{(r.title.toLowerCase().includes(n.toLowerCase())||this.stripHtml(r.content).toLowerCase().includes(n.toLowerCase()))&&c.push({type:"Página",title:r.title,content:this.stripHtml(r.content).substring(0,100)+"...",action:()=>this.editPage(r.id)})}),this.userData.notes.forEach(r=>{(r.title.toLowerCase().includes(n.toLowerCase())||this.stripHtml(r.content).toLowerCase().includes(n.toLowerCase()))&&c.push({type:"Nota",title:r.title,content:this.stripHtml(r.content).substring(0,100)+"...",action:()=>this.editNote(r.id)})}),this.library.forEach(r=>{(r.title.toLowerCase().includes(n.toLowerCase())||r.author.toLowerCase().includes(n.toLowerCase())||r.description.toLowerCase().includes(n.toLowerCase()))&&c.push({type:"Livro",title:r.title,content:`por ${r.author} - ${r.description.substring(0,80)}...`,action:()=>{this.showTab("library"),this.searchLibrary(n),e.remove()}})}),c.length===0?s.innerHTML='<div class="search-no-results">Nenhum resultado encontrado</div>':(s.innerHTML=c.map((r,l)=>`
                    <div class="search-result-item" data-index="${l}">
                        <div class="search-result-type">${r.type}</div>
                        <div class="search-result-title">${r.title}</div>
                        <div class="search-result-content">${r.content}</div>
                    </div>
                `).join(""),c.forEach((r,l)=>{s.querySelector(`[data-index="${l}"]`).addEventListener("click",()=>{r.action(),e.remove()})}))};t.addEventListener("input",n=>{o(n.target.value)}),a.addEventListener("click",()=>e.remove()),e.addEventListener("click",n=>{n.target===e&&e.remove()}),document.addEventListener("keydown",n=>{n.key==="Escape"&&e.remove()})}setupAutoBackup(){setInterval(()=>{this.currentUser&&(this.saveUserData(),console.log("Backup automático realizado"))},5*60*1e3)}setupFavoriteSystem(){const e=localStorage.getItem("rhodium_favorites");if(e){const t=JSON.parse(e);this.library.forEach(s=>{t.includes(s.id)&&(s.favorite=!0)})}}encrypt(e,t="rhodium_secret_key"){let s="";for(let a=0;a<e.length;a++)s+=String.fromCharCode(e.charCodeAt(a)^t.charCodeAt(a%t.length));return btoa(s)}decrypt(e,t="rhodium_secret_key"){try{const s=atob(e);let a="";for(let o=0;o<s.length;o++)a+=String.fromCharCode(s.charCodeAt(o)^t.charCodeAt(o%t.length));return a}catch(s){return console.error("Decryption error:",s),null}}async loadUserDataFromSupabase(){var e,t,s,a,o,n,c;if(!this.currentUser)return{openaiKey:"",geminiKey:"",preferredAI:"gemini"};if(!this.supabase)return this.userData=this.loadUserDataLocally(),this.chatSessions=this.userData.chatSessions||[this.createNewChat()],this.currentChatId=(e=this.chatSessions[0])==null?void 0:e.id,{openaiKey:((t=this.userData)==null?void 0:t.openaiKey)||"",geminiKey:((s=this.userData)==null?void 0:s.geminiKey)||"",preferredAI:((a=this.userData)==null?void 0:a.preferredAI)||"gemini"};try{const{data:r,error:l}=await this.supabase.from("Codes").select("user_data").eq("code",this.currentUser.code).single();if(l)console.warn("Supabase falhou, carregando local..."),this.userData=this.loadUserDataLocally();else if(r!=null&&r.user_data){const h=this.decrypt(r.user_data);h?this.userData=JSON.parse(h):this.initializeUserData()}else this.initializeUserData()}catch(r){console.warn("Erro de conexão, usando dados locais:",r),this.userData=this.loadUserDataLocally()}if(this.chatSessions=this.userData.chatSessions||[],this.chatSessions.length===0){const r={id:Date.now().toString()+"_default",title:"Nova Conversa",messages:[],createdAt:new Date().toISOString()};this.chatSessions=[r],this.currentChatId=r.id}else this.currentChatId=this.chatSessions[0].id;return{openaiKey:((o=this.userData)==null?void 0:o.openaiKey)||"",geminiKey:((n=this.userData)==null?void 0:n.geminiKey)||"",preferredAI:((c=this.userData)==null?void 0:c.preferredAI)||"gemini"}}async saveUserDataToSupabase(e=null){if(this.currentUser){if(e&&(this.userData={...this.userData,openaiKey:e.openaiKey,geminiKey:e.geminiKey,preferredAI:e.preferredAI}),this.userData.chatSessions=this.chatSessions,this.saveUserDataLocally(this.userData),!this.supabase){console.log("Dados salvos localmente (Supabase não configurado)");return}try{const t=this.encrypt(JSON.stringify(this.userData)),s=new Date().toISOString(),{error:a}=await this.supabase.from("Codes").update({user_data:t,last_saved:s}).eq("code",this.currentUser.code);a?console.error("Erro ao salvar dados no Supabase:",a):console.log("Dados do usuário salvos no Supabase")}catch(t){console.warn("Falha ao salvar no Supabase. Dados salvos localmente:",t)}}}saveUserDataLocally(e){localStorage.setItem("userDataBackup",JSON.stringify(e))}loadUserDataLocally(){const e=localStorage.getItem("userDataBackup");return e?JSON.parse(e):{pages:[],notes:[]}}async generateUniqueCode(){let e,t=!0;const s=JSON.parse(localStorage.getItem("rhodium_offline_users")||"[]");for(;t;){e=Math.random().toString(36).substring(2,10).toUpperCase();const a=s.some(o=>o.code===e);if(!this.supabase)t=a;else try{const{data:o,error:n}=await this.supabase.from("Codes").select("code").eq("code",e).limit(1);n?(console.error("Erro ao verificar código único:",n),t=a):t=o.length>0||a}catch(o){console.warn("Erro de rede, usando verificação local:",o),t=a}}return this.supabase||(s.push({code:e,created_at:new Date().toISOString()}),localStorage.setItem("rhodium_offline_users",JSON.stringify(s))),e}async checkAuthState(){const e=localStorage.getItem("rhodium_current_user");e?(this.currentUser=JSON.parse(e),await this.loadUserDataFromSupabase(),this.showMainApp(),this.renderPages(),this.renderNotes()):this.showLogin()}async register(e){if(!e.trim())return this.showCustomPopup("Por favor, insira um nome válido.","error"),!1;const t=await this.generateUniqueCode(),s={pages:[],notes:[]},a={id:Date.now().toString(),name:e.trim(),code:t,created_at:new Date().toISOString(),last_saved:new Date().toISOString()};if(this.supabase)try{const o=this.encrypt(JSON.stringify(s)),{error:n}=await this.supabase.from("Codes").insert({...a,user_data:o});n&&(console.error("Erro ao criar conta no Supabase:",n),this.showCustomPopup("Erro ao criar conta. Usando modo offline.","warning"))}catch(o){console.warn("Criando conta em modo offline:",o)}return this.currentUser={id:a.id,name:a.name,code:a.code,createdAt:a.created_at,lastSaved:a.last_saved},this.userData=s,localStorage.setItem("rhodium_current_user",JSON.stringify(this.currentUser)),this.saveUserDataLocally(this.userData),this.showMainApp(),this.showGeneratedCode(t),!0}async login(e){const t=e.trim().toUpperCase();if(this.supabase)try{const{data:s,error:a}=await this.supabase.from("Codes").select("*").eq("code",t).single();if(a||!s)return this.showCustomPopup("Código inválido.","error"),!1;this.currentUser={id:s.id,name:s.name,code:s.code,createdAt:s.created_at,lastSaved:s.last_saved}}catch{return this.showCustomPopup("Erro de conexão. Tente novamente.","error"),!1}else{const a=JSON.parse(localStorage.getItem("rhodium_offline_users")||"[]").find(o=>o.code===t);if(!a)return this.showCustomPopup("Código inválido. No modo offline, apenas códigos criados neste dispositivo funcionam.","error"),!1;this.currentUser=a}return localStorage.setItem("rhodium_current_user",JSON.stringify(this.currentUser)),await this.loadUserDataFromSupabase(),this.showMainApp(),this.renderPages(),this.renderNotes(),!0}showGeneratedCode(e){this.showCustomPopup(`Sua conta foi criada com sucesso!<br><br><strong>Seu código de acesso é: ${e}</strong><br><br>Guarde este código com segurança, você precisará dele para fazer login.`,"success",!0)}logout(){this.currentUser=null,this.userData={pages:[],notes:[]},localStorage.removeItem("rhodium_current_user"),this.showLogin()}toggleCodeVisibility(){this.isCodeVisible=!this.isCodeVisible;const e=document.getElementById("userCodeDisplay"),t=document.getElementById("toggleCodeBtn");this.isCodeVisible?(e.textContent=this.currentUser.code,e.classList.add("revealed"),e.style.backdropFilter="none",t.innerHTML='<i class="fas fa-eye-slash"></i>'):(e.textContent="••••••••",e.classList.remove("revealed"),e.style.backdropFilter="blur(8px)",t.innerHTML='<i class="fas fa-eye"></i>')}showLogin(){document.getElementById("loginScreen").classList.add("active"),document.getElementById("registerScreen").classList.remove("active"),document.getElementById("mainApp").classList.remove("active"),this.fadeTo(document.getElementById("mainApp"))}showRegister(){document.getElementById("loginScreen").classList.remove("active"),document.getElementById("registerScreen").classList.add("active"),document.getElementById("mainApp").classList.remove("active"),this.fadeTo(document.getElementById("mainApp"))}showMainApp(){document.getElementById("loginScreen").classList.remove("active"),document.getElementById("registerScreen").classList.remove("active"),document.getElementById("mainApp").classList.add("active"),this.fadeTo(document.getElementById("mainApp")),this.currentUser&&(document.getElementById("userName").textContent=this.currentUser.name,document.getElementById("userCodeDisplay").textContent="••••••••",this.isCodeVisible=!1,this.updateSettingsDisplay(),this.renderChatSessions(),this.renderChatMessages())}updateSettingsDisplay(){var e,t,s;if(this.currentUser){const a=document.getElementById("settingsUserName"),o=document.getElementById("userCodeDisplay");a&&(a.textContent=this.currentUser.name),o&&(o.textContent=this.isCodeVisible?this.currentUser.code:"••••••••",o.style.backdropFilter=this.isCodeVisible?"none":"blur(8px)");const n=document.getElementById("openaiKey"),c=document.getElementById("geminiKey"),r=document.getElementById("preferredAI");n&&(n.value=((e=this.userData)==null?void 0:e.openaiKey)||""),c&&(c.value=((t=this.userData)==null?void 0:t.geminiKey)||""),r&&(r.value=((s=this.userData)==null?void 0:s.preferredAI)||"gemini")}}setupTabs(){const e=document.querySelectorAll(".nav-item");e.forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.tab;this.showTab(s),e.forEach(a=>a.classList.remove("active")),t.classList.add("active")})})}showTab(e){document.querySelectorAll(".tab-content").forEach(a=>a.classList.remove("active"));const s=document.getElementById(e);s&&s.classList.add("active"),e==="workspace"?this.renderPages():e==="notes"?this.renderNotes():e==="library"&&this.renderLibrary(),localStorage.setItem("rhodium_last_tab",e)}initializeUserData(){this.userData={pages:[],notes:[]},this.saveUserDataToSupabase()}saveUserData(){this.saveUserDataToSupabase()}createPage(e="Nova Página",t=""){const s={id:Date.now().toString(),title:e,content:t,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.userData.pages.push(s),this.saveUserData(),s}editPage(e){const t=this.userData.pages.find(s=>s.id===e);t&&(this.currentPage=t,this.showPageEditor(t))}savePage(){if(this.currentPage){const e=document.getElementById("pageTitle").value,t=document.getElementById("pageContent").innerHTML;this.currentPage.title=e||"Sem título",this.currentPage.content=t,this.currentPage.updatedAt=new Date().toISOString(),this.currentPage.lastEdited=new Date().toISOString(),this.saveUserData(),this.hidePageEditor(),this.renderPages()}}deletePage(e){this.showCustomConfirm("Tem certeza que deseja excluir esta página?",()=>{this.userData.pages=this.userData.pages.filter(t=>t.id!==e),this.saveUserData(),this.renderPages(),this.showToast("Página excluída com sucesso!","success")})}showPageEditor(e){document.getElementById("pageTitle").value=e.title,document.getElementById("pageContent").innerHTML=e.content,document.getElementById("pageEditor").classList.remove("hidden"),document.getElementById("pagesList").style.display="none"}hidePageEditor(){document.getElementById("pageEditor").classList.add("hidden"),document.getElementById("pagesList").style.display="grid",this.currentPage=null}renderPages(){const e=document.getElementById("pagesList");e.innerHTML="",this.userData.pages.forEach(t=>{const s=document.createElement("div");s.className="page-card drag-item",s.draggable=!0,s.innerHTML=`
              <h3>${t.title}</h3>
              <p>${this.stripHtml(t.content).substring(0,100)}${t.content.length>100?"...":""}</p>
              <div class="page-date">Atualizado em ${new Date(t.updatedAt).toLocaleDateString("pt-BR")}</div>
              <div style="margin-top: 15px;">
                  <button onclick="app.editPage('${t.id}')" class="btn-secondary" style="margin-right: 10px;">EDITAR</button>
                  <button onclick="app.deletePage('${t.id}')" class="btn-secondary" style="background: #000000; color: white;">EXCLUIR</button>
              </div>
          `,e.appendChild(s)})}createNote(e="Nova Nota",t=""){const s=new Date().toISOString(),a={id:Date.now().toString(),title:e,content:t,createdAt:s,lastEdited:s};return this.userData.notes.push(a),this.saveUserData(),this.renderNotes(),a}editNote(e){const t=this.userData.notes.find(s=>s.id===e);t&&(this.currentNote=t,this.showNoteEditor(t))}saveNote(){var e,t;if(this.currentNote){const s=(e=document.getElementById("noteTitle"))==null?void 0:e.value,a=(t=document.getElementById("noteContent"))==null?void 0:t.innerHTML;this.currentNote.title=s||"Sem título",this.currentNote.content=a,this.currentNote.lastEdited=new Date().toISOString(),this.saveUserData(),this.hideNoteEditor(),this.renderNotes()}}deleteNote(e){this.showCustomConfirm("Tem certeza que deseja excluir esta nota?",()=>{this.userData.notes=this.userData.notes.filter(t=>t.id!==e),this.saveUserData(),this.renderNotes(),this.showToast("Nota excluída com sucesso!","success")})}showNoteEditor(e){document.getElementById("noteTitle").value=e.title,document.getElementById("noteContent").innerHTML=e.content,document.getElementById("noteEditor").classList.remove("hidden"),document.getElementById("notesList").style.display="none"}hideNoteEditor(){document.getElementById("noteEditor").classList.add("hidden"),document.getElementById("notesList").style.display="grid",this.currentNote=null}renderNotes(){const e=document.getElementById("notesList");e.innerHTML="",this.userData.notes.forEach(t=>{const s=document.createElement("div");s.className="note-card drag-item",s.draggable=!0;const a=new Date(t.createdAt).toLocaleDateString("pt-BR"),o=t.lastEdited?` • Editado em ${new Date(t.lastEdited).toLocaleString("pt-BR")}`:"";s.innerHTML=`
              <h3>${t.title}</h3>
              <p>${this.stripHtml(t.content).substring(0,150)}${t.content.length>150?"...":""}</p>
              <div class="note-date">Criado em ${a}${o}</div>
              <div style="margin-top: 15px;">
                  <button onclick="app.editNote('${t.id}')" class="btn-secondary" style="margin-right: 10px;">EDITAR</button>
                  <button onclick="app.deleteNote('${t.id}')" class="btn-secondary" style="background: #000000; color: white;">EXCLUIR</button>
              </div>
          `,e.appendChild(s)})}async processPDF(e,t="summarize"){try{document.getElementById("loadingOverlay").classList.remove("hidden");const s=await e.arrayBuffer(),a=await pdfjsLib.getDocument(s).promise;let o="",n={totalPages:a.numPages,pageTexts:[],headings:[],paragraphs:[]};for(let c=1;c<=a.numPages;c++){const h=(await(await a.getPage(c)).getTextContent()).items.map(f=>f.str).join(" ");o+=h+`
`,n.pageTexts.push({page:c,text:h,wordCount:h.split(" ").length})}switch(t){case"summarize":const c=await this.generateSummary(o);document.getElementById("summaryText").textContent=c,document.getElementById("summaryResult").classList.remove("hidden");break;case"extract":document.getElementById("extractedText").textContent=o,document.getElementById("textResult").classList.remove("hidden");break;case"structure":this.analyzeStructure(o,n);break;case"questions":const r=this.generateQuestions(o);document.getElementById("generatedQuestions").innerHTML=r,document.getElementById("questionsResult").classList.remove("hidden");break}}catch(s){console.error("PDF processing error:",s),this.showCustomPopup("Erro ao processar PDF. Verifique se o arquivo é válido.","error")}finally{document.getElementById("loadingOverlay").classList.add("hidden")}}async generateSummary(e){var o,n,c,r,l,h,f,v,C,w,d,m,p;const t=((o=this.userData)==null?void 0:o.openaiKey)||"",s=((n=this.userData)==null?void 0:n.geminiKey)||"",a=((c=this.userData)==null?void 0:c.preferredAI)||"gemini";if(a==="openai"&&t||a==="gemini"&&s)try{const E=`Faça um resumo detalhado e bem estruturado do seguinte texto em português brasileiro:

${e.substring(0,8e3)}`;if(a==="openai"&&t.startsWith("sk-")){const g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:E}],temperature:.3,max_tokens:1e3})});if(g.ok)return((f=(h=(l=(r=(await g.json()).choices)==null?void 0:r[0])==null?void 0:l.message)==null?void 0:h.content)==null?void 0:f.trim())||this.fallbackSummary(e)}else if(a==="gemini"&&s.startsWith("AIza")){const g=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:E}]}],generationConfig:{temperature:.3,maxOutputTokens:1e3}})});if(g.ok)return((p=(m=(d=(w=(C=(v=(await g.json()).candidates)==null?void 0:v[0])==null?void 0:C.content)==null?void 0:w.parts)==null?void 0:d[0])==null?void 0:m.text)==null?void 0:p.trim())||this.fallbackSummary(e)}}catch(E){console.warn("Erro ao gerar resumo com IA, usando método local:",E)}return this.fallbackSummary(e)}fallbackSummary(e){const t=e.split(/[.!?]+/).filter(r=>r.trim().length>0),s=e.toLowerCase().split(/\s+/),a={};s.forEach(r=>{const l=r.replace(/[^\w]/g,"");l.length>3&&(a[l]=(a[l]||0)+1)});const o=t.map(r=>{const l=r.toLowerCase().split(/\s+/);let h=0;return l.forEach(f=>{const v=f.replace(/[^\w]/g,"");a[v]&&(h+=a[v])}),{sentence:r.trim(),score:h}});o.sort((r,l)=>l.score-r.score);const n=Math.min(8,Math.ceil(t.length*.4));return o.slice(0,n).map(r=>r.sentence).join(". ")+"."}analyzeStructure(e,t){const s=e.split(`
`),a=[],o=[];s.forEach((c,r)=>{const l=c.trim();l.length>0&&(l.length<100&&/^[A-Z]/.test(l)?a.push(`Linha ${r+1}: ${l}`):l.length>50&&o.push(`Parágrafo ${o.length+1}: ${l.substring(0,100)}...`))});const n=`
          <h4>INFORMAÇÕES GERAIS:</h4>
          <p>Total de páginas: ${t.totalPages}</p>
          <p>Total de palavras: ${e.split(" ").length}</p>
          <p>Total de caracteres: ${e.length}</p>

          <h4>POSSÍVEIS TÍTULOS/CABEÇALHOS:</h4>
          <ul>${a.slice(0,10).map(c=>`<li>${c}</li>`).join("")}</ul>

          <h4>ESTRUTURA DE PARÁGRAFOS:</h4>
          <ul>${o.slice(0,5).map(c=>`<li>${c}</li>`).join("")}</ul>
      `;document.getElementById("documentStructure").innerHTML=n,document.getElementById("structureResult").classList.remove("hidden")}generateQuestions(e){const t=e.split(/[.!?]+/).filter(n=>n.trim().length>20),s=this.extractKeywords(e),a=[];return s.slice(0,5).forEach(n=>{a.push(`O que é ${n}?`),a.push(`Como ${n} se relaciona com o tema principal?`)}),t.filter(n=>n.length>50&&n.length<200).slice(0,3).forEach(n=>{n.includes("porque")||n.includes("causa")?a.push(`Por que ${n.split(" ").slice(0,5).join(" ")}...?`):a.push(`Explique: ${n.substring(0,80)}...`)}),a.map((n,c)=>`<p><strong>Pergunta ${c+1}:</strong> ${n}</p>`).join("")}extractKeywords(e){const t=e.toLowerCase().split(/\s+/),s=new Set(["o","a","os","as","um","uma","de","do","da","dos","das","em","no","na","nos","nas","para","por","com","sem","sob","sobre","entre","até","desde","durante","através","mediante","conforme","segundo","perante","ante","após","antes","contra","desde","exceto","salvo","menos","mais","muito","pouco","tanto","quanto","qual","que","quem","onde","quando","como","porque","se","mas","ou","e","nem","também","já","ainda","só","apenas","mesmo","até","inclusive","exclusive"]),a={};return t.forEach(o=>{const n=o.replace(/[^\w]/g,"");n.length>4&&!s.has(n)&&(a[n]=(a[n]||0)+1)}),Object.entries(a).sort((o,n)=>n[1]-o[1]).slice(0,10).map(o=>o[0])}setupTextTools(){var s,a,o,n,c,r,l,h,f,v,C,w;const e=document.getElementById("wordCountText"),t=document.getElementById("formatText");e&&e.addEventListener("input",()=>{const d=e.value,m=d.split(/\s+/).filter(S=>S.length>0),p=d.split(/[.!?]+/).filter(S=>S.trim().length>0),E=d.split(`
`).filter(S=>S.trim().length>0);document.getElementById("charCount").textContent=d.length,document.getElementById("wordCount").textContent=m.length,document.getElementById("paragraphCount").textContent=E.length;const g=p.length>0?Math.round(m.length/p.length):0,y=m.length>0?Math.round(d.replace(/\s/g,"").length/m.length):0,k=Math.ceil(m.length/200),B=document.getElementById("sentenceCount"),D=document.getElementById("avgWords"),b=document.getElementById("avgChars"),I=document.getElementById("readingTime");B&&(B.textContent=p.length),D&&(D.textContent=g),b&&(b.textContent=y),I&&(I.textContent=k+" min")}),(s=document.getElementById("upperCase"))==null||s.addEventListener("click",()=>{const d=t.value;document.getElementById("formatResult").value=d.toUpperCase()}),(a=document.getElementById("lowerCase"))==null||a.addEventListener("click",()=>{const d=t.value;document.getElementById("formatResult").value=d.toLowerCase()}),(o=document.getElementById("titleCase"))==null||o.addEventListener("click",()=>{const d=t.value;document.getElementById("formatResult").value=d.replace(/\w\S*/g,m=>m.charAt(0).toUpperCase()+m.substr(1).toLowerCase())}),(n=document.getElementById("removeSpaces"))==null||n.addEventListener("click",()=>{const d=t.value;document.getElementById("formatResult").value=d.replace(/\s+/g," ").trim()}),(c=document.getElementById("reverseText"))==null||c.addEventListener("click",()=>{const d=t.value;document.getElementById("formatResult").value=d.split("").reverse().join("")}),(r=document.getElementById("removeLineBreaks"))==null||r.addEventListener("click",()=>{const d=t.value;document.getElementById("formatResult").value=d.replace(/\n/g," ").replace(/\s+/g," ").trim()}),(l=document.getElementById("sortLines"))==null||l.addEventListener("click",()=>{const m=t.value.split(`
`).sort();document.getElementById("formatResult").value=m.join(`
`)}),(h=document.getElementById("removeDuplicates"))==null||h.addEventListener("click",()=>{const m=t.value.split(`
`),p=[...new Set(m)];document.getElementById("formatResult").value=p.join(`
`)}),(f=document.getElementById("addLineNumbers"))==null||f.addEventListener("click",()=>{const p=t.value.split(`
`).map((E,g)=>`${g+1}. ${E}`);document.getElementById("formatResult").value=p.join(`
`)}),(v=document.getElementById("extractEmails"))==null||v.addEventListener("click",()=>{const d=t.value,m=/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,p=d.match(m)||[];document.getElementById("formatResult").value=p.join(`
`)}),(C=document.getElementById("extractUrls"))==null||C.addEventListener("click",()=>{const d=t.value,m=/https?:\/\/[^\s]+/g,p=d.match(m)||[];document.getElementById("formatResult").value=p.join(`
`)}),(w=document.getElementById("countWords"))==null||w.addEventListener("click",()=>{const m=t.value.toLowerCase().split(/\s+/).filter(g=>g.length>0),p={};m.forEach(g=>{const y=g.replace(/[^\w]/g,"");y.length>0&&(p[y]=(p[y]||0)+1)});const E=Object.entries(p).sort((g,y)=>y[1]-g[1]).slice(0,20).map(([g,y])=>`${g}: ${y}`).join(`
`);document.getElementById("formatResult").value=`Top 20 palavras mais usadas:

`+E})}setupAI(){document.getElementById("chatMessages"),document.querySelectorAll(".ai-tool-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.prompt;document.getElementById("aiInput").value=t})})}createNewChat(){const e=Date.now().toString()+"_"+Math.random().toString(36).substr(2,9),t={id:e,title:"Nova Conversa",messages:[],createdAt:new Date().toISOString()};return this.chatSessions.unshift(t),this.currentChatId=e,this.renderChatSessions(),this.renderChatMessages(),this.saveUserData(),t}switchChat(e){this.currentChatId=e,this.renderChatMessages()}deleteChat(e){if(this.chatSessions.length<=1){this.showCustomPopup("Você precisa ter pelo menos uma conversa.","warning");return}this.chatSessions=this.chatSessions.filter(t=>t.id!==e),this.currentChatId===e&&(this.currentChatId=this.chatSessions[0].id),this.renderChatSessions(),this.renderChatMessages(),this.saveUserData()}getCurrentChat(){return this.chatSessions.find(e=>e.id===this.currentChatId)||this.chatSessions[0]}renderChatSessions(){const e=document.getElementById("chatSessions");e&&(e.innerHTML="",this.chatSessions.forEach(t=>{const s=document.createElement("div");s.className=`chat-session ${t.id===this.currentChatId?"active":""}`,s.innerHTML=`
              <div class="chat-session-title" onclick="app.switchChat('${t.id}')">${t.title}</div>
              <button class="delete-chat-btn" onclick="app.deleteChat('${t.id}')" title="Excluir conversa">
                  <i class="fas fa-trash"></i>
              </button>
          `,e.appendChild(s)}))}renderChatMessages(){const e=document.getElementById("chatMessages");if(!e)return;e.innerHTML="";const t=this.getCurrentChat();t&&(t.messages.forEach(s=>{const a=document.createElement("div");a.className=`message ${s.role}`,s.role==="assistant"?a.innerHTML=this.formatMessage(s.content):a.innerHTML=s.content,e.appendChild(a)}),e.scrollTop=e.scrollHeight)}async sendAIMessage(){var f,v,C,w,d,m,p,E,g,y,k,B,D;const e=document.getElementById("aiInput"),t=document.getElementById("chatMessages"),s=e.value.trim();if(!s)return;e.value="";const a=this.getCurrentChat();if(!a)return;const o={role:"user",content:s};a.messages.push(o),a.messages.length===1&&(a.title=s.substring(0,30)+(s.length>30?"...":""),this.renderChatSessions());const n=document.createElement("div");n.className="message user",n.innerHTML=this.formatMessage(s),t.appendChild(n);const c=document.createElement("div");c.className="message ai typing",c.innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Pensando...',t.appendChild(c),t.scrollTop=t.scrollHeight;const r=((f=this.userData)==null?void 0:f.openaiKey)||"",l=((v=this.userData)==null?void 0:v.geminiKey)||"",h=((C=this.userData)==null?void 0:C.preferredAI)||"gemini";try{let b="";const I=a.messages.slice(-10);if(h==="openai"&&r)if(!r.startsWith("sk-"))b="Chave da OpenAI inválida. Verifique nas configurações.";else{const x=I.map(L=>({role:L.role==="assistant"?"assistant":"user",content:L.content})),i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:x,temperature:.7,max_tokens:2e3})});if(!i.ok)throw new Error(`OpenAI API Error: ${i.status} ${i.statusText}`);b=((p=(m=(d=(w=(await i.json()).choices)==null?void 0:w[0])==null?void 0:d.message)==null?void 0:m.content)==null?void 0:p.trim())||"Resposta vazia da OpenAI."}else if(h==="gemini"&&l)if(!l.startsWith("AIza"))b="Chave da Gemini inválida. Verifique nas configurações.";else{const x=[];I.forEach(L=>{x.push({parts:[{text:L.content}],role:L.role==="assistant"?"model":"user"})});const i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:x,generationConfig:{temperature:.7,maxOutputTokens:2e3,topP:.8,topK:10}})});if(!i.ok)throw new Error(`Gemini API Error: ${i.status} ${i.statusText}`);b=((D=(B=(k=(y=(g=(E=(await i.json()).candidates)==null?void 0:E[0])==null?void 0:g.content)==null?void 0:y.parts)==null?void 0:k[0])==null?void 0:B.text)==null?void 0:D.trim())||"Resposta vazia da Gemini."}else b="Nenhuma chave de IA configurada. Vá para Configurações e adicione sua chave da OpenAI ou Gemini.";const S={role:"assistant",content:b};a.messages.push(S),c.className="message ai",c.innerHTML=this.formatMessage(b),this.saveUserData()}catch(b){console.error("Erro ao chamar a IA:",b);const I=`Erro ao gerar resposta da IA: ${b.message}`;c.className="message ai error",c.innerHTML=I,a.messages.push({role:"assistant",content:I})}t.scrollTop=t.scrollHeight}formatMessage(e){let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");t=t.replace(/```(\w+)?\n?([\s\S]*?)```/g,(r,l,h)=>`<pre class="code-block${l?` language-${l}`:""}"><code>${h.trim()}</code></pre>`),t=t.replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>'),t=t.replace(/^### (.*$)/gm,'<h3 class="ai-header">$1</h3>').replace(/^## (.*$)/gm,'<h2 class="ai-header">$1</h2>').replace(/^# (.*$)/gm,'<h1 class="ai-header">$1</h1>').replace(/\*\*\*(.*?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*(.*?)\*\*/g,'<strong class="ai-bold">$1</strong>').replace(/\*(.*?)\*/g,'<em class="ai-italic">$1</em>').replace(/~~(.*?)~~/g,'<del class="ai-strikethrough">$1</del>').replace(/__(.*?)__/g,'<u class="ai-underline">$1</u>').replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" class="ai-link" target="_blank" rel="noopener noreferrer">$1</a>').replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" class="ai-link" target="_blank" rel="noopener noreferrer">$1</a>').replace(/^> (.*$)/gm,'<blockquote class="ai-blockquote">$1</blockquote>').replace(/^\* (.*$)/gm,'<li class="ai-list-item">$1</li>').replace(/^\- (.*$)/gm,'<li class="ai-list-item">$1</li>').replace(/^\+ (.*$)/gm,'<li class="ai-list-item">$1</li>').replace(/^(\d+)\. (.*$)/gm,'<li class="ai-list-item-numbered" data-number="$1">$2</li>').replace(/\|(.+)\|/g,(r,l)=>`<tr class="ai-table-row">${l.split("|").map(v=>v.trim()).map(v=>`<td class="ai-table-cell">${v}</td>`).join("")}</tr>`).replace(/==(.*?)==/g,'<mark class="ai-highlight">$1</mark>').replace(/:\)/g,"😊").replace(/:\(/g,"😞").replace(/:D/g,"😃").replace(/;\)/g,"😉").replace(/<3/g,"❤️").replace(/->/g,"→").replace(/<-/g,"←").replace(/\[x\]/g,"✅").replace(/\[ \]/g,"☐"),t=t.replace(/(<li class="ai-list-item">.*?<\/li>)/gs,'<ul class="ai-list">$1</ul>'),t=t.replace(/(<li class="ai-list-item-numbered".*?<\/li>)/gs,'<ol class="ai-list-ordered">$1</ol>'),t=t.replace(/(<tr class="ai-table-row">.*?<\/tr>)/gs,'<table class="ai-table"><tbody>$1</tbody></table>');const s=t.split(`
`);let a=[],o=!1,n=!1,c=!1;for(let r=0;r<s.length;r++){const l=s[r].trim();l.includes('<pre class="code-block')&&(n=!0),l.includes("</pre>")&&(n=!1),l.includes('<table class="ai-table">')&&(c=!0),l.includes("</table>")&&(c=!1),(l.includes('<ul class="ai-list">')||l.includes('<ol class="ai-list-ordered">'))&&(o=!0),(l.includes("</ul>")||l.includes("</ol>"))&&(o=!1),!n&&!o&&!c&&l&&!l.includes("<h")&&!l.includes("<blockquote")&&!l.includes("<pre")&&!l.includes("<ul")&&!l.includes("<ol")&&!l.includes("<table")?a.push(`<p class="ai-paragraph">${l}</p>`):a.push(l)}return t=a.join(`
`),t=t.replace(/<p class="ai-paragraph"><\/p>/g,""),t=t.replace(/<(h[1-6]|p|li|blockquote)/g,'<$1 class="ai-animate"'),t}generateAIResponse(e){const t={resumir:"Para resumir um texto, identifique as ideias principais e elimine informações redundantes.",traduzir:"Para tradução precisa, considere o contexto e as nuances culturais.",corrigir:"Verificando gramática e ortografia do texto fornecido.",explicar:"Vou explicar o conceito de forma clara e didática."},s=e.toLowerCase();for(const a in t)if(s.includes(a))return t[a];return"Estou aqui para ajudar! Posso resumir textos, traduzir, corrigir gramática ou explicar conceitos. Como posso ajudá-lo?"}stripHtml(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}fadeTo(e){e.classList.remove("fade-in"),e.offsetWidth,e.classList.add("fade-in")}setupCustomCursor(){window.innerWidth<=768||(this.customCursor=document.querySelector(".custom-cursor"),this.customCursor||(this.customCursor=document.createElement("div"),this.customCursor.className="custom-cursor",document.body.appendChild(this.customCursor)),document.addEventListener("mousemove",e=>{this.customCursor.style.left=e.clientX+"px",this.customCursor.style.top=e.clientY+"px"}),document.addEventListener("mousedown",()=>{this.customCursor.classList.add("click"),setTimeout(()=>{this.customCursor.classList.remove("click")},300)}),document.querySelectorAll("button, .nav-item, .page-card, .note-card").forEach(e=>{e.addEventListener("mouseenter",()=>{this.customCursor.classList.add("hover")}),e.addEventListener("mouseleave",()=>{this.customCursor.classList.remove("hover")})}))}setupThemeToggle(){const e=document.querySelectorAll(".theme-btn"),t=document.body;t.setAttribute("data-theme",this.currentTheme),e.forEach(s=>{s.classList.toggle("active",s.dataset.theme===this.currentTheme)}),e.forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.theme;this.currentTheme=a,t.setAttribute("data-theme",a),localStorage.setItem("rhodium_theme",a),e.forEach(o=>o.classList.remove("active")),s.classList.add("active"),this.showToast(`Tema ${a} aplicado!`,"success"),this.playSound("theme")})})}setupSoundSystem(){this.soundEnabled&&document.body.classList.add("sound-enabled")}playSound(e="click"){if(!this.soundEnabled)return;const t=new(window.AudioContext||window.webkitAudioContext),s=t.createOscillator(),a=t.createGain();switch(s.connect(a),a.connect(t.destination),e){case"click":s.frequency.setValueAtTime(800,t.currentTime),a.gain.setValueAtTime(.1,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1);break;case"success":s.frequency.setValueAtTime(523,t.currentTime),s.frequency.setValueAtTime(659,t.currentTime+.1),a.gain.setValueAtTime(.1,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.2);break;case"error":s.frequency.setValueAtTime(200,t.currentTime),a.gain.setValueAtTime(.1,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3);break;case"theme":s.frequency.setValueAtTime(440,t.currentTime),s.frequency.setValueAtTime(880,t.currentTime+.1),a.gain.setValueAtTime(.05,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.2);break}s.start(t.currentTime),s.stop(t.currentTime+.3)}setupToastSystem(){this.toastContainer=document.getElementById("toastContainer"),this.toastContainer||(this.toastContainer=document.createElement("div"),this.toastContainer.className="toast-container",this.toastContainer.id="toastContainer",document.body.appendChild(this.toastContainer))}showToast(e,t="info",s=5e3){const a=this.toastContainer.querySelectorAll(".toast");for(let c of a)if(c.querySelector("div").textContent===e)return;const o=document.createElement("div");o.className=`toast ${t}`,o.innerHTML=`
          <div>${e}</div>
          <button class="toast-close">&times;</button>
      `,this.toastContainer.appendChild(o),setTimeout(()=>o.classList.add("show"),100);const n=setTimeout(()=>{this.removeToast(o)},s);o.querySelector(".toast-close").addEventListener("click",()=>{clearTimeout(n),this.removeToast(o)}),t==="info"&&o.addEventListener("click",()=>{clearTimeout(n),this.removeToast(o)})}removeToast(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}setupDragAndDrop(){this.setupNoteDragDrop(),this.setupPageDragDrop()}setupNoteDragDrop(){let e=null;document.addEventListener("dragstart",t=>{t.target.classList.contains("note-card")&&(e=t.target,t.target.classList.add("dragging"),t.dataTransfer.effectAllowed="move")}),document.addEventListener("dragend",t=>{t.target.classList.contains("note-card")&&(t.target.classList.remove("dragging"),e=null)}),document.addEventListener("dragover",t=>{t.preventDefault(),t.target.closest(".notes-list")&&e&&(t.dataTransfer.dropEffect="move")}),document.addEventListener("drop",t=>{t.preventDefault(),t.target.closest(".notes-list")&&e&&(this.showToast("Nota reorganizada!","success"),this.playSound("success"))})}setupPageDragDrop(){document.addEventListener("dragstart",e=>{e.target.classList.contains("page-card")&&(e.target,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move")}),document.addEventListener("dragend",e=>{e.target.classList.contains("page-card")&&e.target.classList.remove("dragging")})}setupScrollSpy(){const e=document.querySelectorAll(".tab-content"),t=new IntersectionObserver(s=>{s.forEach(a=>{a.isIntersecting?a.target.classList.add("scroll-spy","active"):a.target.classList.remove("active")})},{threshold:.1});e.forEach(s=>t.observe(s))}setupLibrarySystem(){this.library=this.getDefaultLibrary(),this.currentPdfUrl=null,this.renderLibrary()}getDefaultLibrary(){return[{id:"1",title:"Dom Casmurro",author:"Machado de Assis",description:"Obra-prima do realismo brasileiro sobre ciúme e incerteza.",pdfUrl:"https://ddcus.org/pdf/summer_reading/11th_grade/Dom_Casmurro-Machado_de_Assis.pdf",tags:["Literatura Brasileira","Realismo","Clássico"],favorite:!1,category:"Literatura Brasileira"},{id:"2",title:"O Cortiço",author:"Aluísio Azevedo",description:"Romance naturalista sobre a vida em um cortiço no Rio de Janeiro.",pdfUrl:"https://www.curso-objetivo.br/vestibular/assets/download/obras-literarias/aluisio-de-azevedo/o-cortico.pdf",tags:["Literatura Brasileira","Naturalismo","Social"],favorite:!1,category:"Literatura Brasileira"},{id:"3",title:"Iracema",author:"José de Alencar",description:"Romance indianista sobre o amor entre indígena e português.",pdfUrl:"http://www.culturatura.com.br/obras/iracema.pdf",tags:["Literatura Brasileira","Romantismo","Indianismo"],favorite:!1,category:"Literatura Brasileira"},{id:"4",title:"O Guarani",author:"José de Alencar",description:"Romance histórico sobre Peri e Ceci no Brasil colonial.",pdfUrl:"https://bds.unb.br/bitstream/123456789/955/1/O%20Guarani_%C3%ADntegra.pdf",tags:["Literatura Brasileira","Romance Histórico","Colonial"],favorite:!1,category:"Literatura Brasileira"},{id:"5",title:"The Art of War",author:"Sun Tzu",description:"Tratado militar chinês sobre estratégia e táticas de guerra.",pdfUrl:"https://sites.ualberta.ca/~enoch/Readings/The_Art_Of_War.pdf",tags:["Estratégia","História","Filosofia Oriental"],favorite:!1,category:"Estratégia"},{id:"6",title:"The Prince",author:"Niccolò Machiavelli",description:"Tratado político sobre liderança e poder.",pdfUrl:"https://apeiron.iulm.it/retrieve/handle/10808/4129/46589/Machiavelli%2C%20The%20Prince.pdf",tags:["Política","Liderança","Filosofia"],favorite:!1,category:"Política"}]}toggleFavorite(e){const t=this.library.find(s=>s.id===e);t&&(t.favorite=!t.favorite,this.renderLibrary(),this.playSound(t.favorite?"success":"click"))}async openPdfReader(e,t){try{this.currentPdfUrl=e,this.showToast("Carregando PDF...","info"),this.closePdfReader();const s=`https://cors-anywhere.herokuapp.com/${e}`,a=`https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(e)}`,o=document.createElement("div");o.className="pdf-reader-modal",o.innerHTML=`
                <div class="pdf-reader-container glass">
                    <div class="pdf-reader-header">
                        <h3>${t}</h3>
                        <div class="pdf-controls">
                            <button class="pdf-control-btn" onclick="app.downloadPdf('${e}', '${t}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="pdf-control-btn" onclick="app.openInNewTab('${e}')">
                                <i class="fas fa-external-link-alt"></i> Abrir em Nova Aba
                            </button>
                            <button class="close-pdf-btn" onclick="app.closePdfReader()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pdf-reader-content">
                        <iframe src="${a}" 
                                width="100%" height="100%" frameborder="0"
                                allow="autoplay; encrypted-media"
                                onerror="this.src='${e}'">
                        </iframe>
                    </div>
                </div>
            `,document.body.appendChild(o),o.addEventListener("click",c=>{c.target===o&&this.closePdfReader()});const n=c=>{c.key==="Escape"&&(this.closePdfReader(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n),this.showToast("PDF carregado com sucesso!","success")}catch(s){console.error("Erro ao carregar PDF:",s),this.showToast("PDF aberto em nova aba devido a restrições de CORS","info"),this.openInNewTab(e)}}downloadPdf(e,t){const s=document.createElement("a");s.href=e,s.download=`${t}.pdf`,s.target="_blank",document.body.appendChild(s),s.click(),document.body.removeChild(s),this.showToast("Download iniciado!","success")}openInNewTab(e){window.open(e,"_blank"),this.showToast("PDF aberto em nova aba!","success")}closePdfReader(){const e=document.querySelector(".pdf-reader-modal");e&&document.body.removeChild(e),this.currentPdfUrl=null}searchLibrary(e){const t=this.library.filter(s=>s.title.toLowerCase().includes(e.toLowerCase())||s.author.toLowerCase().includes(e.toLowerCase())||s.tags.some(a=>a.toLowerCase().includes(e.toLowerCase())));this.renderLibrary(t)}renderLibrary(e=this.library){const t=document.getElementById("libraryContainer");t&&(t.innerHTML="",e.forEach(s=>{const a=document.createElement("div");a.className="library-item drag-item",a.innerHTML=`
                <div class="library-content">
                    <h4>${s.title}</h4>
                    <p class="library-author">por ${s.author}</p>
                    <p class="library-description">${s.description}</p>
                    <div class="library-tags">
                        ${s.tags.map(o=>`<span class="tag">${o}</span>`).join("")}
                    </div>
                    <div class="library-actions">
                        ${s.pdfUrl?`<button class="btn-primary library-read-btn" onclick="app.openPdfReader('${s.pdfUrl}', '${s.title}')">
                            <i class="fas fa-book-open"></i> LER
                        </button>`:""}
                        <button class="favorite-btn ${s.favorite?"active":""}" onclick="app.toggleFavorite('${s.id}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            `,t.appendChild(a)}))}setupUploadSystem(){document.querySelectorAll(".upload-zone, .drop-zone").forEach(t=>{t.addEventListener("dragenter",s=>{s.preventDefault(),t.classList.add("active")}),t.addEventListener("dragleave",s=>{s.preventDefault(),t.contains(s.relatedTarget)||t.classList.remove("active")}),t.addEventListener("dragover",s=>{s.preventDefault()}),t.addEventListener("drop",s=>{s.preventDefault(),t.classList.remove("active");const a=s.dataTransfer.files;a.length>0&&this.handleFileUpload(a[0],t)})})}handleFileUpload(e,t){this.showUploadProgress(e.name);let s=0;const a=setInterval(()=>{s+=Math.random()*15,s>=100&&(s=100,clearInterval(a),this.showToast(`${e.name} carregado com sucesso!`,"success"),this.playSound("success")),this.updateUploadProgress(s)},200)}showUploadProgress(e){const t=`
          <div class="upload-progress-container">
              <p>Carregando ${e}...</p>
              <div class="upload-progress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
              </div>
          </div>
      `;this.showToast(t,"info",1e4)}updateUploadProgress(e){const t=document.getElementById("uploadProgressBar");t&&(t.style.width=e+"%")}setupSearchSystem(){document.querySelectorAll('input[type="search"], .search-input').forEach(t=>{t.addEventListener("input",s=>{const a=s.target.value.toLowerCase();this.performSearch(a,s.target)})}),document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="f"&&(t.preventDefault(),this.showGlobalSearch())})}performSearch(e,t){document.querySelectorAll(".page-card, .note-card, .library-item").forEach(a=>{const n=a.textContent.toLowerCase().includes(e);a.style.display=n||e===""?"block":"none",n&&e!==""?this.highlightSearchTerms(a,e):this.removeHighlights(a)})}highlightSearchTerms(e,t){this.getTextNodes(e).forEach(a=>{const o=a.textContent,n=new RegExp(`(${t})`,"gi");if(n.test(o)){const c=o.replace(n,'<span class="search-highlight">$1</span>'),r=document.createElement("div");for(r.innerHTML=c;r.firstChild;)a.parentNode.insertBefore(r.firstChild,a);a.parentNode.removeChild(a)}})}removeHighlights(e){e.querySelectorAll(".search-highlight").forEach(s=>{const a=s.parentNode;a.replaceChild(document.createTextNode(s.textContent),s),a.normalize()})}getTextNodes(e){const t=[],s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let a;for(;a=s.nextNode();)t.push(a);return t}showGlobalSearch(){const e=document.createElement("div");e.className="search-modal",e.innerHTML=`
          <div class="search-modal-content glass">
              <input type="text" class="search-input" placeholder="Pesquisar em todo o Rhodium..." autofocus>
              <div class="search-results"></div>
              <button class="search-close">&times;</button>
          </div>
      `,document.body.appendChild(e),e.querySelector(".search-close").addEventListener("click",()=>{document.body.removeChild(e)}),e.addEventListener("click",s=>{s.target===e&&document.body.removeChild(e)})}setupPDFViewer(){this.pdfViewerState={currentPage:1,totalPages:0,scale:1,highlights:[],comments:[]}}ensureDefaultTheme(){const e=localStorage.getItem("rhodium_theme");e?(this.currentTheme=e,document.body.setAttribute("data-theme",e)):(this.currentTheme="classic",document.body.setAttribute("data-theme","classic"),localStorage.setItem("rhodium_theme","classic"))}setupDevLogs(){this.devLogs=JSON.parse(localStorage.getItem("rhodium_dev_logs")||"[]");const e=console.log,t=console.error,s=console.warn;console.log=(...a)=>{this.addDevLog("log",a.join(" ")),e.apply(console,a)},console.error=(...a)=>{this.addDevLog("error",a.join(" ")),t.apply(console,a)},console.warn=(...a)=>{this.addDevLog("warn",a.join(" ")),s.apply(console,a)}}addDevLog(e,t){const s={type:e,message:t,timestamp:new Date().toISOString(),url:window.location.href};this.devLogs.unshift(s),this.devLogs.length>1e3&&(this.devLogs=this.devLogs.slice(0,1e3)),localStorage.setItem("rhodium_dev_logs",JSON.stringify(this.devLogs))}showDevLogs(e){if(e!=="rhodium_dev_2024")return!1;const t=document.createElement("div");return t.className="dev-log-modal",t.innerHTML=`
          <div class="dev-log-content glass">
              <h3>LOGS DE DESENVOLVIMENTO</h3>
              <div class="dev-log-list">
                  ${this.devLogs.map(s=>`
                      <div class="dev-log-item ${s.type}">
                          <span class="log-time">${new Date(s.timestamp).toLocaleTimeString()}</span>
                          <span class="log-type">[${s.type.toUpperCase()}]</span>
                          <span class="log-message">${s.message}</span>
                      </div>
                  `).join("")}
              </div>
              <button class="log-close">FECHAR</button>
          </div>
      `,document.body.appendChild(t),t.querySelector(".log-close").addEventListener("click",()=>{document.body.removeChild(t)}),!0}showCustomPopup(e,t="info",s=!1){document.querySelectorAll(".custom-popup-overlay").forEach(n=>n.remove());const o=document.createElement("div");o.className="custom-popup-overlay",o.innerHTML=`
            <div class="custom-popup glass ${s?"large":""}">
                <div class="popup-content">
                    <div class="popup-icon ${t}">
                        ${this.getPopupIcon(t)}
                    </div>
                    <div class="popup-message">${e}</div>
                    <button class="popup-btn btn-primary" onclick="this.closest('.custom-popup-overlay').remove()">
                        OK
                    </button>
                </div>
            </div>
        `,document.body.appendChild(o),this.playSound(t==="error"?"error":"success"),t!=="error"&&setTimeout(()=>{o.parentNode&&o.remove()},5e3)}showCustomConfirm(e,t,s=null){const a=document.createElement("div");a.className="custom-popup-overlay",a.innerHTML=`
            <div class="custom-popup glass">
                <div class="popup-content">
                    <div class="popup-icon warning">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="popup-message">${e}</div>
                    <div class="popup-buttons">
                        <button class="popup-btn btn-secondary cancel-btn">CANCELAR</button>
                        <button class="popup-btn btn-primary confirm-btn">CONFIRMAR</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(a),a.querySelector(".confirm-btn").addEventListener("click",()=>{a.remove(),t&&t()}),a.querySelector(".cancel-btn").addEventListener("click",()=>{a.remove(),s&&s()}),this.playSound("click")}getPopupIcon(e){const t={success:'<i class="fas fa-check-circle"></i>',error:'<i class="fas fa-exclamation-circle"></i>',warning:'<i class="fas fa-exclamation-triangle"></i>',info:'<i class="fas fa-info-circle"></i>'};return t[e]||t.info}removeExistingEventListeners(){["addPageBtn","savePageBtn","closeEditorBtn","addNoteBtn","saveNoteBtn","closeNoteBtn","sendAi","newChatBtn","salvar-config","loginForm","registerForm","logoutBtn","settingsBtn","toggleCodeBtn","showRegister","showLogin"].forEach(t=>{const s=document.getElementById(t);if(s&&s.parentNode){const a=s.cloneNode(!0);s.parentNode.replaceChild(a,s)}}),document.querySelectorAll(".toolbar-btn").forEach(t=>{if(t.parentNode){const s=t.cloneNode(!0);t.parentNode.replaceChild(s,t)}})}bindEvents(){var n,c,r,l,h,f,v,C,w,d,m,p,E,g,y,k,B,D,b,I,S,x;if(this.eventsInitialized)return;this.eventsInitialized=!0,this.removeExistingEventListeners();const e=document.getElementById("loginForm");e&&e.addEventListener("submit",i=>{i.preventDefault();const u=document.getElementById("loginCode").value;this.login(u)});const t=document.getElementById("registerForm");t&&t.addEventListener("submit",i=>{i.preventDefault();const u=document.getElementById("registerName").value;this.register(u)}),(n=document.getElementById("toggleCodeBtn"))==null||n.addEventListener("click",()=>{this.toggleCodeVisibility()}),(c=document.getElementById("showRegister"))==null||c.addEventListener("click",()=>{this.showRegister()}),(r=document.getElementById("showLogin"))==null||r.addEventListener("click",()=>{this.showLogin()}),(l=document.getElementById("logoutBtn"))==null||l.addEventListener("click",()=>{this.logout()}),(h=document.getElementById("settingsBtn"))==null||h.addEventListener("click",()=>{this.showTab("settings"),document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active")),document.querySelector('[data-tab="settings"]').classList.add("active"),this.updateSettingsDisplay()}),(f=document.getElementById("addPageBtn"))==null||f.addEventListener("click",()=>{const i=this.createPage();this.editPage(i.id)}),(v=document.getElementById("savePageBtn"))==null||v.addEventListener("click",()=>{this.savePage()}),(C=document.getElementById("closeEditorBtn"))==null||C.addEventListener("click",()=>{this.hidePageEditor()}),(w=document.getElementById("addNoteBtn"))==null||w.addEventListener("click",()=>{const i=this.createNote();this.editNote(i.id)}),(d=document.getElementById("saveNoteBtn"))==null||d.addEventListener("click",()=>{this.saveNote()}),(m=document.getElementById("closeNoteBtn"))==null||m.addEventListener("click",()=>{this.hideNoteEditor()}),document.querySelectorAll(".toolbar-btn").forEach(i=>{i.addEventListener("click",()=>{const u=i.dataset.action,L=i.dataset.value;if(u==="insertImage"){const T=prompt("URL da imagem:");T&&document.execCommand("insertImage",!1,T)}else if(u==="createLink"){const T=prompt("URL do link:");T&&document.execCommand("createLink",!1,T)}else u==="formatBlock"?document.execCommand(u,!1,L):document.execCommand(u,!1,null)})});const s=document.getElementById("uploadZone"),a=document.getElementById("pdfInput");s.addEventListener("click",()=>{a.click()}),s.addEventListener("dragover",i=>{i.preventDefault(),s.style.background="#e0e0e0"}),s.addEventListener("dragleave",i=>{i.preventDefault(),s.style.background="#f8f8f8"}),s.addEventListener("drop",i=>{i.preventDefault(),s.style.background="#f8f8f8";const u=i.dataTransfer.files;u.length>0&&u[0].type==="application/pdf"&&this.handlePDFUpload(u[0])}),a.addEventListener("change",i=>{i.target.files.length>0&&this.handlePDFUpload(i.target.files[0])}),(p=document.getElementById("summarizePdf"))==null||p.addEventListener("click",()=>{const i=a.files[0];i&&this.processPDF(i,"summarize")}),(E=document.getElementById("extractText"))==null||E.addEventListener("click",()=>{const i=a.files[0];i&&this.processPDF(i,"extract")}),(g=document.getElementById("analyzeStructure"))==null||g.addEventListener("click",()=>{const i=a.files[0];i&&this.processPDF(i,"structure")}),(y=document.getElementById("generateQuestions"))==null||y.addEventListener("click",()=>{const i=a.files[0];i&&this.processPDF(i,"questions")}),(k=document.getElementById("saveSummary"))==null||k.addEventListener("click",()=>{const i=document.getElementById("summaryText").textContent,u=document.getElementById("fileName").textContent;this.createNote(`Resumo: ${u}`,i),this.showToast("Resumo salvo nas suas notas!","success")}),(B=document.getElementById("saveText"))==null||B.addEventListener("click",()=>{const i=document.getElementById("extractedText").textContent,u=document.getElementById("fileName").textContent;this.createNote(`Texto extraído: ${u}`,i),this.showToast("Texto salvo nas suas notas!","success")}),(D=document.getElementById("saveQuestions"))==null||D.addEventListener("click",()=>{const i=document.getElementById("generatedQuestions").innerHTML,u=document.getElementById("fileName").textContent;this.createNote(`Perguntas: ${u}`,i),this.showToast("Perguntas salvas nas suas notas!","success")}),(b=document.getElementById("sendAi"))==null||b.addEventListener("click",()=>{this.sendAIMessage()}),(I=document.getElementById("aiInput"))==null||I.addEventListener("keypress",i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),this.sendAIMessage())}),(S=document.getElementById("newChatBtn"))==null||S.addEventListener("click",()=>{this.createNewChat()}),(x=document.getElementById("salvar-config"))==null||x.addEventListener("click",async()=>{var A,$,P;const i=((A=document.getElementById("openaiKey"))==null?void 0:A.value.trim())||"",u=(($=document.getElementById("geminiKey"))==null?void 0:$.value.trim())||"",L=((P=document.getElementById("preferredAI"))==null?void 0:P.value)||"gemini";if(!i&&!u){this.showToast("Pelo menos uma chave deve ser preenchida!","error"),this.playSound("error");return}const T={openaiKey:i,geminiKey:u,preferredAI:L};try{await this.saveUserDataToSupabase(T),this.showToast("Configurações salvas com sucesso!","success"),this.playSound("success")}catch(U){console.error("Erro ao salvar configurações:",U),this.showToast("Erro ao salvar configurações. Tente novamente.","error"),this.playSound("error")}}),this.soundEventsAdded||(this.soundEventsAdded=!0,document.addEventListener("click",i=>{i.target.matches("button, .nav-item, .btn-primary, .btn-secondary")&&this.playSound("click")},{once:!1,passive:!0})),document.addEventListener("keydown",i=>{if(i.ctrlKey&&i.key==="s"&&(i.preventDefault(),this.currentPage?this.savePage():this.currentNote&&this.saveNote(),this.showToast("Salvamento rápido!","success")),i.ctrlKey&&i.key==="n"){i.preventDefault();const u=document.querySelector(".tab-content.active");if(u.id==="workspace"){const L=this.createPage();this.editPage(L.id)}else if(u.id==="notes"){const L=this.createNote();this.editNote(L.id)}}i.key==="Escape"&&(document.getElementById("pageEditor").classList.contains("hidden")||this.hidePageEditor(),document.getElementById("noteEditor").classList.contains("hidden")||this.hideNoteEditor())});let o="";document.addEventListener("keydown",i=>{if(o+=i.key,o.length>20&&(o=o.slice(-20)),o.includes("devlogs")){const u=prompt("Código secreto:");this.showDevLogs(u)&&(o="")}}),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").catch(i=>{console.log("Service Worker registration failed:",i)}),window.addEventListener("online",()=>{this.showToast("Conexão restaurada!","success"),this.syncOfflineData()}),window.addEventListener("offline",()=>{this.showToast("Modo offline ativado","warning")}),document.getElementById("addBookForm").addEventListener("submit",async function(i){i.preventDefault();const u=document.getElementById("bookTitle").value,L=document.getElementById("bookAuthor").value,T=document.getElementById("bookDescription").value;await N.addBook(u,L,T),bootstrap.Modal.getInstance(document.getElementById("addBookModal")).hide(),i.target.reset(),this.renderLibrary()})}syncOfflineData(){const e=localStorage.getItem("rhodium_offline_changes");e&&(JSON.parse(e),this.saveUserDataToSupabase(),localStorage.removeItem("rhodium_offline_changes"),this.showToast("Dados sincronizados!","success"))}handlePDFUpload(e){document.getElementById("fileName").textContent=e.name,document.getElementById("pdfPreview").classList.remove("hidden"),document.querySelectorAll(".zzresult-section").forEach(t=>{t.classList.add("hidden")})}createButton(e,t=""){const s=document.createElement("button");return s.className=`btn btn-standard ${t}`,s.textContent=e,s}}const N=new O;window.app=N;window.addEventListener("DOMContentLoaded",()=>{N.init()});
